{
  "cells": [
    {
      "cell_type": "markdown",
      "metadata": {
        "id": "view-in-github",
        "colab_type": "text"
      },
      "source": [
        "<a href=\"https://colab.research.google.com/github/Pamela-Data-Analyst/Horizonte_Empresarial360/blob/main/main.py\" target=\"_parent\"><img src=\"https://colab.research.google.com/assets/colab-badge.svg\" alt=\"Open In Colab\"/></a>"
      ]
    },
    {
      "cell_type": "code",
      "source": [
        "import streamlit as st\n",
        "import pandas as pd\n",
        "import numpy as np\n",
        "import plotly.express as px\n",
        "import plotly.graph_objects as go\n",
        "import statsmodels.api as sm\n",
        "from io import BytesIO\n",
        "import warnings\n",
        "from datetime import datetime, timedelta\n",
        "from typing import Dict, Any, List\n",
        "\n",
        "# Ocultar advertencias de Streamlit y Pandas\n",
        "warnings.filterwarnings('ignore')\n",
        "st.set_option('deprecation.showPyplotGlobalUse', False)\n",
        "\n",
        "# ==============================================================================\n",
        "# 1. CONFIGURACI√ìN INICIAL Y CONSTANTES GLOBALES\n",
        "# ==============================================================================\n",
        "\n",
        "st.set_page_config(\n",
        "    page_title=\"Horizonte Empresarial 360 - Acuamar S.A.\",\n",
        "    page_icon=\"üåä\",\n",
        "    layout=\"wide\",\n",
        "    initial_sidebar_state=\"expanded\"\n",
        ")\n",
        "\n",
        "# --- Constantes de Negocio (Globales) ---\n",
        "UMBRAL_LIQUIDEZ_MINIMA = 0.0 # Umbral para la alerta de Cash Flow\n",
        "TASA_IVA_GENERAL = 0.19\n",
        "TASA_IMPUESTO_RENTA = 0.35\n",
        "TASA_RETENCION_FUENTE = 0.025\n",
        "TASA_ROTACION_CARTERA_DIAS = 30 # D√≠as de rotaci√≥n de cartera\n",
        "HORIZONTE_PROYECCION_DEFAULT = 12 # Meses de proyecci√≥n por defecto\n",
        "NUM_SIMULACIONES_DEFAULT = 5000 # N√∫mero de simulaciones de Monte Carlo\n",
        "\n",
        "# Factores Ambientales (Para Huella de Carbono)\n",
        "EF_COMBUSTIBLE = 2.68  # Kg CO2e/L\n",
        "EF_ELECTRICO = 0.20    # Kg CO2e/kWh\n",
        "DIAS_TRABAJO_ANUAL = 240 # Para c√°lculo de Indicadores HSEQ\n",
        "\n",
        "MODULOS = [\n",
        "    \"Dashboard General\",\n",
        "    \"M√≥dulo Gobernanza y Due√±os\",\n",
        "    \"M√≥dulo Financiero\",\n",
        "    \"M√≥dulo Sostenibilidad Social RRHH\",\n",
        "    \"M√≥dulo Sostenibilidad Ambiental\",\n",
        "    \"M√≥dulo Riesgos HSEQ\",\n",
        "    \"M√≥dulo Comercial\",\n",
        "    \"M√≥dulo Operativo (Productividad)\"\n",
        "]\n",
        "\n",
        "# ==============================================================================\n",
        "# 2. AUTENTICACI√ìN Y SEGURIDAD (Simulaci√≥n)\n",
        "# ==============================================================================\n",
        "\n",
        "def check_password():\n",
        "    \"\"\"Retorna `True` si el usuario ingres√≥ la contrase√±a correcta.\"\"\"\n",
        "\n",
        "    def password_entered():\n",
        "        \"\"\"Verifica si la contrase√±a es correcta.\"\"\"\n",
        "        if (st.session_state[\"username\"] == \"usuario_demo\" and\n",
        "            st.session_state[\"password\"] == \"demo360\"):\n",
        "            st.session_state[\"password_correct\"] = True\n",
        "            del st.session_state[\"password\"]  # Eliminar para seguridad\n",
        "            del st.session_state[\"username\"]\n",
        "        else:\n",
        "            st.session_state[\"password_correct\"] = False\n",
        "\n",
        "    if \"password_correct\" not in st.session_state:\n",
        "        # Primera ejecuci√≥n, muestra la entrada de contrase√±a.\n",
        "        st.title(\"üåä Horizonte Empresarial 360\")\n",
        "        st.info(\"Acceso restringido. Por favor, ingrese sus credenciales.\")\n",
        "        col1, col2 = st.columns(2)\n",
        "        with col1:\n",
        "            st.text_input(\"Usuario\", key=\"username\")\n",
        "        with col2:\n",
        "            st.text_input(\"Contrase√±a\", type=\"password\", on_change=password_entered, key=\"password\")\n",
        "        return False\n",
        "    elif not st.session_state[\"password_correct\"]:\n",
        "        # Contrase√±a incorrecta, muestra el mensaje de error.\n",
        "        st.error(\"üòï Usuario o Contrase√±a incorrectos.\")\n",
        "        col1, col2 = st.columns(2)\n",
        "        with col1:\n",
        "            st.text_input(\"Usuario\", key=\"username\")\n",
        "        with col2:\n",
        "            st.text_input(\"Contrase√±a\", type=\"password\", on_change=password_entered, key=\"password\")\n",
        "        return False\n",
        "    else:\n",
        "        # Contrase√±a correcta.\n",
        "        return True\n",
        "\n",
        "# ==============================================================================\n",
        "# 3. CARGA DE DATOS Y PRE-PROCESAMIENTO\n",
        "# ==============================================================================\n",
        "\n",
        "@st.cache_data\n",
        "def load_data_from_upload(uploaded_files: List[Any]) -> Dict[str, pd.DataFrame]:\n",
        "    \"\"\"Carga y pre-procesa todos los DataFrames necesarios desde archivos XLSX.\"\"\"\n",
        "\n",
        "    # Mapeo de nombre de hoja a variable de sesi√≥n y nombre de columna de FECHA\n",
        "    data_map_sheet_to_info = {\n",
        "        'financiero': {'var': 'df_financiero', 'date_col': 'FECHA'},\n",
        "        'comercial': {'var': 'df_comercial', 'date_col': 'FECHA_TRANSACCION'},\n",
        "        'rrhh_social': {'var': 'df_rrhh', 'date_col': 'FECHA'},\n",
        "        'sostenibilidad': {'var': 'df_sostenibilidad', 'date_col': 'Fecha_Reporte'},\n",
        "        'riesgos_hseq': {'var': 'df_riesgos', 'date_col': 'FECHA'},\n",
        "        'productividad': {'var': 'df_operativo', 'date_col': 'FECHA'}, # Asumiendo 'productividad' es el nombre de la hoja\n",
        "    }\n",
        "\n",
        "    loaded_data = {}\n",
        "    st.sidebar.markdown(\"---\")\n",
        "    st.sidebar.subheader(\"Estado de Carga de Datos\")\n",
        "\n",
        "    for file in uploaded_files:\n",
        "        try:\n",
        "            xls = pd.ExcelFile(file)\n",
        "            for sheet_name in xls.sheet_names:\n",
        "                map_info = None\n",
        "                # Buscar la informaci√≥n de mapeo para el nombre de la hoja (insensible a may√∫sculas/min√∫sculas)\n",
        "                for k, v in data_map_sheet_to_info.items():\n",
        "                    if k.lower() == sheet_name.lower():\n",
        "                        map_info = v\n",
        "                        break\n",
        "\n",
        "                if map_info is None:\n",
        "                    st.sidebar.info(f\"‚è≠Ô∏è Saltando hoja '{sheet_name}' en '{file.name}' (no reconocida o no necesaria).\")\n",
        "                    continue\n",
        "\n",
        "                df = pd.read_excel(xls, sheet_name=sheet_name)\n",
        "\n",
        "                # Conversi√≥n de fechas\n",
        "                if map_info['date_col'] in df.columns:\n",
        "                    df[map_info['date_col']] = pd.to_datetime(df[map_info['date_col']], errors='coerce')\n",
        "\n",
        "                # Renombrar columna de fecha a un est√°ndar 'FECHA' para consistencia\n",
        "                df.rename(columns={map_info['date_col']: 'FECHA'}, inplace=True)\n",
        "\n",
        "                # Pre-procesamiento espec√≠fico\n",
        "                if map_info['var'] == 'df_comercial':\n",
        "                    df['Ingreso_Total'] = df['Volumen_Vendido'] * df['Precio_Unitario_Real']\n",
        "                    df['Costo_Total'] = df['Volumen_Vendido'] * df['Costo_Venta_Unitario']\n",
        "                    df['Margen_Bruto'] = df['Ingreso_Total'] - df['Costo_Total']\n",
        "\n",
        "                if map_info['var'] == 'df_sostenibilidad':\n",
        "                    # Calcular Huella de Carbono (Alcance 1: Combustible, Alcance 2: Electricidad)\n",
        "                    df['CO2e_Combustible'] = df['Consumo_Combustible_ACPM'] * EF_COMBUSTIBLE\n",
        "                    df['CO2e_Electrico'] = df['Consumo_Electrico_kWh'] * EF_ELECTRICO\n",
        "                    df['Huella_CO2e_Total'] = df['CO2e_Combustible'] + df['CO2e_Electrico']\n",
        "\n",
        "                if map_info['var'] == 'df_riesgos':\n",
        "                    # Calcular Costo Total por Evento HSEQ\n",
        "                    df.rename(columns={'Costo_Total_Evento': 'Costo_Total_Accidente'}, inplace=True)\n",
        "\n",
        "                if map_info['var'] == 'df_rrhh':\n",
        "                    # Calcular Costo por FTE (Full-Time Equivalent)\n",
        "                    df['Costo_x_FTE'] = df['Costo_Total_Nomina'] / df['FTEs_Promedio']\n",
        "\n",
        "                if map_info['var'] == 'df_operativo':\n",
        "                    # Calcular OEE (Overall Equipment Effectiveness) - Simplificado\n",
        "                    df['OEE_Teorico'] = (df['Unidades_Producidas'] / (df['Horas_Disponibles'] * (df['Unidades_Producidas'].mean() / df['Horas_Operadas'].mean()))).clip(upper=1.0)\n",
        "                    df['Tasa_Defectos'] = df['Unidades_Defectuosas'] / df['Unidades_Producidas']\n",
        "                    df['Costo_Total_Reproceso'] = df['Unidades_Defectuosas'] * df['Costo_Reproceso_Unit']\n",
        "\n",
        "                # Guardar el DataFrame\n",
        "                loaded_data[map_info['var']] = df\n",
        "                st.sidebar.success(f\"‚úÖ Cargado: {map_info['var'].replace('df_', '').upper()} (desde hoja '{sheet_name}' de '{file.name}')\")\n",
        "\n",
        "        except Exception as e:\n",
        "            st.sidebar.error(f\"‚ùå Error al cargar/procesar el archivo '{file.name}' o alguna de sus hojas: {e}\")\n",
        "\n",
        "    # Verificar que todos los DataFrames requeridos est√©n presentes\n",
        "    required_dfs = ['df_financiero', 'df_comercial', 'df_rrhh', 'df_sostenibilidad', 'df_riesgos', 'df_operativo']\n",
        "    for df_name in required_dfs:\n",
        "        if df_name not in loaded_data:\n",
        "            loaded_data[df_name] = pd.DataFrame() # DataFrame vac√≠o si falta\n",
        "\n",
        "    return loaded_data\n",
        "\n",
        "\n",
        "# ==============================================================================\n",
        "# 4. FUNCIONES DE C√ÅLCULO Y VISUALIZACI√ìN POR M√ìDULO\n",
        "# ==============================================================================\n",
        "\n",
        "# --- M√≥dulo de Gobernanza y Due√±os ---\n",
        "def display_gobernanza_module(all_dfs: Dict[str, pd.DataFrame]):\n",
        "    st.title(\"üëë M√≥dulo Gobernanza y Due√±os\")\n",
        "    st.subheader(\"Visi√≥n Estrat√©gica y Health Score\")\n",
        "\n",
        "    df_financiero = all_dfs.get('df_financiero')\n",
        "    df_sostenibilidad = all_dfs.get('df_sostenibilidad')\n",
        "    df_riesgos = all_dfs.get('df_riesgos')\n",
        "    df_rrhh = all_dfs.get('df_rrhh')\n",
        "\n",
        "    st.markdown(\"\"\"\n",
        "        Este m√≥dulo consolida el rendimiento de la organizaci√≥n en un *Health Score* integral para la toma de decisiones al m√°s alto nivel.\n",
        "    \"\"\")\n",
        "\n",
        "    # 1. Indicadores Clave de Desempe√±o (KPIs Consolidado)\n",
        "    st.subheader(\"Indicadores Clave Consolidados (√öltimo Periodo)\")\n",
        "\n",
        "    if not df_financiero.empty and not df_sostenibilidad.empty and not df_riesgos.empty:\n",
        "        latest_date = df_financiero['FECHA'].max().strftime('%Y-%m')\n",
        "        st.caption(f\"Datos consolidados hasta: {latest_date}\")\n",
        "\n",
        "        # Indicador Financiero (Margen Neto Operativo Simplificado)\n",
        "        # Se asume que Ventas_Gravadas es proxy de Ingresos y Gastos_Gravados + Gasto_Nomina es proxy de Egresos Operativos\n",
        "        last_fin = df_financiero.loc[df_financiero['FECHA'].idxmax()]\n",
        "        ingresos = last_fin['Ventas_Gravadas']\n",
        "        egresos_operativos = last_fin['Gastos_Gravados'] + last_fin['Gasto_Nomina']\n",
        "        margen_neto_op = ingresos - egresos_operativos\n",
        "\n",
        "        # Indicador Ambiental (Cumplimiento)\n",
        "        num_incumplimientos = df_sostenibilidad['Incumplimientos_Vencidos'].sum()\n",
        "        max_posible_incumplimientos = df_sostenibilidad.shape[0] * 4 # Maximo 4 por mes (ejemplo)\n",
        "        cumplimiento_ambiental = 1 - (num_incumplimientos / max_posible_incumplimientos) if max_posible_incumplimientos > 0 else 1\n",
        "\n",
        "        # Indicador Social (Rotaci√≥n)\n",
        "        avg_rotacion = df_rrhh['Tasa_Rotacion_Anual'].mean() / 100 # Promedio hist√≥rico\n",
        "\n",
        "        # Indicador Riesgos (√çndice de Gravedad)\n",
        "        total_dias_perdidos = df_riesgos['Dias_Perdidos'].sum()\n",
        "        total_horas_trabajadas = df_riesgos['Horas_Trabajadas_Periodo'].sum()\n",
        "        indice_gravedad = (total_dias_perdidos / total_horas_trabajadas) * 240000\n",
        "\n",
        "        # Simulaci√≥n de Health Score (0 a 100)\n",
        "        score_financiero = min(100, max(0, (margen_neto_op / (ingresos * 0.15)) * 50)) # Basado en 15% de margen como meta\n",
        "        score_ambiental = cumplimiento_ambiental * 100\n",
        "        score_social = min(100, max(0, (1 - (avg_rotacion / 0.18)) * 100)) # Basado en 18% de rotaci√≥n como m√°ximo\n",
        "        score_riesgos = min(100, max(0, (1 - (indice_gravedad / 50)) * 100)) # Basado en 50 como √≠ndice de gravedad m√°xima\n",
        "\n",
        "        health_score = (score_financiero * 0.35 + score_ambiental * 0.25 + score_social * 0.20 + score_riesgos * 0.20)\n",
        "\n",
        "        col1, col2, col3, col4, col5 = st.columns(5)\n",
        "\n",
        "        col1.metric(\"Ingresos √öltimo Mes\", f\"COP {ingresos:,.0f}\", delta_color=\"normal\")\n",
        "        col2.metric(\"Margen Operativo\", f\"COP {margen_neto_op:,.0f}\", delta_color=\"normal\")\n",
        "        col3.metric(\"Huella CO2e Acumulada\", f\"{df_sostenibilidad['Huella_CO2e_Total'].sum():,.0f} Kg\", delta_color=\"inverse\")\n",
        "        col4.metric(\"Tasa de Rotaci√≥n Anual (Promedio)\", f\"{avg_rotacion*100:.2f}%\", delta_color=\"inverse\")\n",
        "        col5.metric(\"√çndice de Gravedad HSEQ\", f\"{indice_gravedad:.2f}\", delta_color=\"inverse\")\n",
        "\n",
        "        st.markdown(\"---\")\n",
        "        st.subheader(\"üéØ Health Score Empresarial 360\")\n",
        "        st.metric(\"Health Score General\", f\"{health_score:.1f}/100\",\n",
        "                  help=\"√çndice ponderado basado en el rendimiento financiero, ambiental, social y de riesgos.\")\n",
        "\n",
        "        fig = go.Figure(go.Indicator(\n",
        "            mode = \"gauge+number\",\n",
        "            value = health_score,\n",
        "            domain = {'x': [0, 1], 'y': [0, 1]},\n",
        "            title = {'text': \"Health Score Empresarial\"},\n",
        "            gauge = {'axis': {'range': [None, 100], 'tickwidth': 1, 'tickcolor': \"darkblue\"},\n",
        "                     'bar': {'color': \"green\"},\n",
        "                     'steps': [\n",
        "                         {'range': [0, 50], 'color': \"red\"},\n",
        "                         {'range': [50, 75], 'color': \"yellow\"},\n",
        "                         {'range': [75, 100], 'color': \"green\"}],\n",
        "                     'threshold': {'line': {'color': \"red\", 'width': 4}, 'thickness': 0.75, 'value': 75}}))\n",
        "\n",
        "        st.plotly_chart(fig, use_container_width=True)\n",
        "    else:\n",
        "        st.warning(\"No hay datos cargados para generar el Health Score. Aseg√∫rese de cargar todos los archivos requeridos.\")\n",
        "\n",
        "\n",
        "# --- M√≥dulo Financiero ---\n",
        "def display_financiero_module(df_financiero: pd.DataFrame, HORIZONTE_PROYECCION: int, NUM_SIMULACIONES: int):\n",
        "    st.title(\"üí∞ M√≥dulo Financiero: Gesti√≥n de Liquidez y Cash Flow\")\n",
        "    st.subheader(\"Proyecci√≥n de Flujo de Caja (Cash Flow)\")\n",
        "\n",
        "    if df_financiero.empty:\n",
        "        st.warning(\"No se encontraron datos financieros. Por favor, cargue el archivo `financiero.xlsx`.\")\n",
        "        return\n",
        "\n",
        "    # 1. Configuraci√≥n de Simulaci√≥n\n",
        "    st.markdown(\"---\")\n",
        "    with st.expander(\"‚öôÔ∏è Configuraci√≥n de Escenarios de Proyecci√≥n\"):\n",
        "        st.info(\"La proyecci√≥n usa la media hist√≥rica y la desviaci√≥n est√°ndar de los flujos de caja (Cobros y Pagos) para simular el riesgo (M√©todo Monte Carlo).\")\n",
        "        st.caption(\"Ajuste los par√°metros del simulador:\")\n",
        "\n",
        "        # Inputs para el usuario\n",
        "        col1, col2 = st.columns(2)\n",
        "        with col1:\n",
        "            cobros_ajuste = st.number_input(\"Ajuste de Cobros (% sobre media hist√≥rica)\", min_value=-50, max_value=50, value=0, help=\"Ajusta la media de Cobros. Ej: 5 para un escenario optimista (+5%).\")\n",
        "        with col2:\n",
        "            pagos_ajuste = st.number_input(\"Ajuste de Pagos (% sobre media hist√≥rica)\", min_value=-50, max_value=50, value=0, help=\"Ajusta la media de Pagos. Ej: -5 para un escenario optimista en costos (-5%).\")\n",
        "\n",
        "    # 2. An√°lisis Hist√≥rico de Flujos\n",
        "    df_financiero = df_financiero.sort_values('FECHA').copy()\n",
        "    df_financiero['Flujo_Neto'] = df_financiero['Cobros_Clientes'] - (df_financiero['Pagos_Proveedores'] + df_financiero['Gasto_Nomina'])\n",
        "    df_financiero['Efectivo_Final'] = df_financiero['Efectivo_Inicial'].shift(-1).fillna(df_financiero['Efectivo_Inicial'] + df_financiero['Flujo_Neto'])\n",
        "\n",
        "    st.subheader(\"An√°lisis Hist√≥rico de Efectivo\")\n",
        "    col_hist1, col_hist2 = st.columns(2)\n",
        "    with col_hist1:\n",
        "        st.metric(\"Flujo Neto Promedio Mensual\", f\"COP {df_financiero['Flujo_Neto'].mean():,.0f}\")\n",
        "    with col_hist2:\n",
        "        st.metric(\"Efectivo Final (√öltimo Periodo)\", f\"COP {df_financiero['Efectivo_Final'].iloc[-2]:,.0f}\") # -2 porque el √∫ltimo valor es el de inicio del siguiente\n",
        "\n",
        "    # Gr√°fico Hist√≥rico\n",
        "    fig_hist = px.line(df_financiero.tail(24), x='FECHA', y=['Cobros_Clientes', 'Pagos_Proveedores', 'Gasto_Nomina'],\n",
        "                       title='Tendencia Hist√≥rica de Flujos de Caja (√öltimos 2 A√±os)',\n",
        "                       labels={'value': 'COP', 'FECHA': 'Fecha', 'variable': 'Tipo de Flujo'})\n",
        "    fig_hist.update_layout(hovermode=\"x unified\", legend_title_text='Flujo')\n",
        "    st.plotly_chart(fig_hist, use_container_width=True)\n",
        "\n",
        "    # 3. Simulaci√≥n de Monte Carlo (Flujo de Caja Proyectado)\n",
        "\n",
        "    # Estad√≠sticas para la simulaci√≥n\n",
        "    flujo_neto_mean = df_financiero['Flujo_Neto'].mean()\n",
        "    flujo_neto_std = df_financiero['Flujo_Neto'].std()\n",
        "\n",
        "    # Ajuste de la media seg√∫n el input del usuario\n",
        "    ajuste_factor = (1 + (cobros_ajuste / 100)) - (1 + (pagos_ajuste / 100))\n",
        "    flujo_neto_mean_ajustado = flujo_neto_mean * (1 + ajuste_factor / 2) # Ajuste simple\n",
        "\n",
        "\n",
        "    # Punto de partida de la simulaci√≥n\n",
        "    start_date = df_financiero['FECHA'].max() + pd.DateOffset(months=1)\n",
        "    effective_start_cash = df_financiero['Efectivo_Final'].iloc[-1] # Efectivo final del √∫ltimo mes registrado\n",
        "\n",
        "    st.subheader(f\"Simulaci√≥n de {NUM_SIMULACIONES} Escenarios a {HORIZONTE_PROYECCION} Meses\")\n",
        "\n",
        "    try:\n",
        "        simulations = []\n",
        "        for _ in range(NUM_SIMULACIONES):\n",
        "            # Generar variaciones mensuales (Normal Distribution)\n",
        "            monthly_flows = np.random.normal(loc=flujo_neto_mean_ajustado, scale=flujo_neto_std, size=HORIZONTE_PROYECCION)\n",
        "\n",
        "            # Calcular el flujo acumulado\n",
        "            cash_flow_projection = [effective_start_cash]\n",
        "            for flow in monthly_flows:\n",
        "                cash_flow_projection.append(cash_flow_projection[-1] + flow)\n",
        "\n",
        "            simulations.append(cash_flow_projection[1:])\n",
        "\n",
        "        df_sim = pd.DataFrame(simulations).T\n",
        "        df_sim.columns = [f'Sim_{i+1}' for i in range(NUM_SIMULACIONES)]\n",
        "\n",
        "        # Creaci√≥n de fechas de proyecci√≥n\n",
        "        projected_dates = [start_date + pd.DateOffset(months=i) for i in range(HORIZONTE_PROYECCION)]\n",
        "        df_sim['FECHA'] = projected_dates\n",
        "        df_sim = df_sim.set_index('FECHA')\n",
        "\n",
        "        # C√°lculo de percentiles\n",
        "        df_sim['Media'] = df_sim.mean(axis=1)\n",
        "        df_sim['P5'] = df_sim.quantile(0.05, axis=1)  # Escenario Pesimista\n",
        "        df_sim['P95'] = df_sim.quantile(0.95, axis=1) # Escenario Optimista\n",
        "\n",
        "        # Gr√°fico de Proyecci√≥n\n",
        "        fig_proj = go.Figure()\n",
        "\n",
        "        # Bandas de confianza (Percentiles 5 y 95)\n",
        "        fig_proj.add_trace(go.Scatter(x=df_sim.index, y=df_sim['P95'], fill=None, mode='lines',\n",
        "                                      line_color='rgba(0,176,246,0.3)', name='Percentil 95% (Optimista)'))\n",
        "        fig_proj.add_trace(go.Scatter(x=df_sim.index, y=df_sim['P5'], fill='tonexty', mode='lines',\n",
        "                                      line_color='rgba(255,160,0,0.3)', name='Percentil 5% (Pesimista)'))\n",
        "\n",
        "        # L√≠nea de Media\n",
        "        fig_proj.add_trace(go.Scatter(x=df_sim.index, y=df_sim['Media'], mode='lines',\n",
        "                                      line=dict(color='blue', width=2), name='Proyecci√≥n Media'))\n",
        "\n",
        "        # Umbral de Liquidez M√≠nima\n",
        "        fig_proj.add_hline(y=UMBRAL_LIQUIDEZ_MINIMA, line_width=2, line_dash=\"dash\", line_color=\"red\",\n",
        "                           annotation_text=f\"Umbral de Alerta ({UMBRAL_LIQUIDEZ_MINIMA:,.0f} COP)\", annotation_position=\"bottom right\")\n",
        "\n",
        "        fig_proj.update_layout(title=f'Proyecci√≥n de Efectivo Final a {HORIZONTE_PROYECCION} Meses',\n",
        "                               yaxis_title='Efectivo (COP)', xaxis_title='Mes de Proyecci√≥n',\n",
        "                               hovermode=\"x unified\")\n",
        "        st.plotly_chart(fig_proj, use_container_width=True)\n",
        "\n",
        "        # 4. Conclusi√≥n de Riesgo\n",
        "        risk_months = df_sim[df_sim['P5'] <= UMBRAL_LIQUIDEZ_MINIMA].shape[0]\n",
        "        if risk_months > 0:\n",
        "            st.error(f\"üö® ALERTA DE RIESGO: El Escenario Pesimista (P5) predice que el Efectivo Final caer√° por debajo del umbral de liquidez m√≠nima (COP {UMBRAL_LIQUIDEZ_MINIMA:,.0f}) en {risk_months} de los {HORIZONTE_PROYECCION} meses proyectados. Se recomienda aplicar estrategias de gesti√≥n de capital de trabajo y cobranza.\")\n",
        "        else:\n",
        "            st.success(\"‚úÖ La proyecci√≥n de liquidez es saludable. El Escenario Pesimista (P5) se mantiene por encima del umbral de alerta.\")\n",
        "\n",
        "    except Exception as e:\n",
        "        st.error(f\"Error al ejecutar la simulaci√≥n de Monte Carlo: {e}\")\n",
        "        st.info(\"Aseg√∫rese de que las columnas `Cobros_Clientes`, `Pagos_Proveedores`, y `Gasto_Nomina` sean num√©ricas y no contengan valores nulos significativos.\")\n",
        "\n",
        "    # 5. Descarga de Reporte\n",
        "    st.markdown(\"---\")\n",
        "    def create_pdf_report(df: pd.DataFrame) -> BytesIO:\n",
        "        \"\"\"Simulaci√≥n de generaci√≥n de reporte PDF (usa CSV como placeholder).\"\"\"\n",
        "        output = BytesIO()\n",
        "        # En una aplicaci√≥n real, usar√≠as ReportLab o FPDF para generar un PDF.\n",
        "        # Aqu√≠, generamos el DF de simulaci√≥n como CSV para la descarga.\n",
        "        df.to_csv(output, index=True)\n",
        "        output.seek(0)\n",
        "        return output\n",
        "\n",
        "    if 'df_sim' in locals():\n",
        "        report_buffer = create_pdf_report(df_sim[['Media', 'P5', 'P95']])\n",
        "        st.download_button(\n",
        "            label=\"Descargar Reporte de Proyecci√≥n Financiera (CSV)\",\n",
        "            data=report_buffer,\n",
        "            file_name=\"Reporte_Proyeccion_Cash_Flow.csv\",\n",
        "            mime=\"text/csv\"\n",
        "        )\n",
        "\n",
        "# --- M√≥dulo de Sostenibilidad Social RRHH ---\n",
        "def display_rrhh_module(df_rrhh: pd.DataFrame):\n",
        "    st.title(\"üë®‚Äçüë©‚Äçüëß‚Äçüë¶ M√≥dulo Sostenibilidad Social y RRHH\")\n",
        "\n",
        "    if df_rrhh.empty:\n",
        "        st.warning(\"No se encontraron datos de RRHH. Por favor, cargue el archivo `rrhh_social.xlsx`.\")\n",
        "        return\n",
        "\n",
        "    # 1. Indicadores Clave\n",
        "    st.subheader(\"Indicadores Clave de Talento\")\n",
        "\n",
        "    latest_date = df_rrhh['FECHA'].max()\n",
        "    latest_data = df_rrhh[df_rrhh['FECHA'] == latest_date].iloc[0]\n",
        "\n",
        "    col1, col2, col3, col4 = st.columns(4)\n",
        "    col1.metric(\"FTEs Promedio (√öltimo Periodo)\", f\"{latest_data['FTEs_Promedio']:.1f}\")\n",
        "    col2.metric(\"Tasa de Rotaci√≥n Anual\", f\"{latest_data['Tasa_Rotacion_Anual']:.2f}%\", delta_color=\"inverse\")\n",
        "    col3.metric(\"Costo por FTE (√öltimo Periodo)\", f\"COP {latest_data['Costo_x_FTE']:,.0f}\")\n",
        "    col4.metric(\"Inversi√≥n en Capacitaci√≥n (Acumulada)\", f\"COP {df_rrhh['Inversion_Capacitacion'].sum():,.0f}\")\n",
        "\n",
        "    # 2. An√°lisis de Tendencia\n",
        "    st.subheader(\"Tendencia de Rotaci√≥n vs. Inversi√≥n en Capacitaci√≥n\")\n",
        "\n",
        "    fig1 = px.line(df_rrhh.sort_values('FECHA'), x='FECHA', y='Tasa_Rotacion_Anual',\n",
        "                   title='Tasa de Rotaci√≥n Anual por Mes',\n",
        "                   labels={'Tasa_Rotacion_Anual': 'Tasa de Rotaci√≥n (%)', 'FECHA': 'Fecha'})\n",
        "    st.plotly_chart(fig1, use_container_width=True)\n",
        "\n",
        "    fig2 = px.bar(df_rrhh.sort_values('FECHA'), x='FECHA', y='Inversion_Capacitacion',\n",
        "                  title='Inversi√≥n Mensual en Capacitaci√≥n',\n",
        "                  labels={'Inversion_Capacitacion': 'Inversi√≥n (COP)', 'FECHA': 'Fecha'})\n",
        "    st.plotly_chart(fig2, use_container_width=True)\n",
        "\n",
        "    # 3. Distribuci√≥n de Costo por FTE\n",
        "    st.subheader(\"Distribuci√≥n de Costo Total de N√≥mina\")\n",
        "\n",
        "    fig3 = px.histogram(df_rrhh, x='Costo_x_FTE', nbins=20,\n",
        "                        title='Distribuci√≥n de Costo por FTE a lo largo del tiempo',\n",
        "                        labels={'Costo_x_FTE': 'Costo por FTE (COP)'})\n",
        "    st.plotly_chart(fig3, use_container_width=True)\n",
        "\n",
        "\n",
        "# --- M√≥dulo de Sostenibilidad Ambiental ---\n",
        "def display_sostenibilidad_ambiental_module(df_sostenibilidad: pd.DataFrame):\n",
        "    st.title(\"üå≥ M√≥dulo Sostenibilidad Ambiental\")\n",
        "    st.subheader(\"Monitoreo de Huella y Cumplimiento\")\n",
        "\n",
        "    if df_sostenibilidad.empty:\n",
        "        st.warning(\"No se encontraron datos de Sostenibilidad Ambiental. Por favor, cargue el archivo `sostenibilidad.xlsx`.\")\n",
        "        return\n",
        "\n",
        "    df = df_sostenibilidad.sort_values('FECHA').copy()\n",
        "\n",
        "    # 1. Indicadores Clave\n",
        "    st.subheader(\"M√©tricas de Impacto Ambiental\")\n",
        "\n",
        "    total_co2 = df['Huella_CO2e_Total'].sum()\n",
        "    total_agua = df['Consumo_Agua_Total_m3'].sum()\n",
        "    total_residuos = df['Kg_Residuos_Solidos'].sum()\n",
        "    total_multa = df['Costo_Multa_Ambiental'].sum()\n",
        "\n",
        "    col1, col2, col3, col4 = st.columns(4)\n",
        "    col1.metric(\"Huella CO2e Total (Kg)\", f\"{total_co2:,.0f}\", delta_color=\"inverse\")\n",
        "    col2.metric(\"Consumo Agua Total (m¬≥)\", f\"{total_agua:,.0f} m¬≥\", delta_color=\"inverse\")\n",
        "    col3.metric(\"Residuos S√≥lidos (Kg)\", f\"{total_residuos:,.0f} Kg\", delta_color=\"inverse\")\n",
        "    col4.metric(\"Costo Acumulado Multas\", f\"COP {total_multa:,.0f}\", delta_color=\"inverse\")\n",
        "\n",
        "    # 2. Huella de Carbono por Alcance (Gr√°fico de torta/sol)\n",
        "    st.subheader(\"Huella de Carbono (Alcance 1 y 2)\")\n",
        "\n",
        "    co2_alcance = pd.DataFrame({\n",
        "        'Alcance': ['Alcance 1 (Combustible)', 'Alcance 2 (Electricidad)'],\n",
        "        'CO2e': [df['CO2e_Combustible'].sum(), df['CO2e_Electrico'].sum()]\n",
        "    })\n",
        "\n",
        "    fig_co2 = px.pie(co2_alcance, values='CO2e', names='Alcance',\n",
        "                     title='Distribuci√≥n de Huella de Carbono (Kg CO2e)',\n",
        "                     color_discrete_sequence=px.colors.sequential.Agsunset)\n",
        "    st.plotly_chart(fig_co2, use_container_width=True)\n",
        "\n",
        "    # 3. Tendencia de Consumos Cr√≠ticos\n",
        "    st.subheader(\"Tendencia de Consumos y Descargas de DBO5\")\n",
        "\n",
        "    fig_cons = px.line(df, x='FECHA', y=['Consumo_Combustible_ACPM', 'Consumo_Electrico_kWh', 'Consumo_Agua_Total_m3'],\n",
        "                       title='Consumo de Recursos (Mensual)',\n",
        "                       labels={'value': 'Unidad de Consumo', 'variable': 'Recurso', 'FECHA': 'Fecha'})\n",
        "    fig_cons.add_trace(go.Bar(x=df['FECHA'], y=df['Descarga_DBO5_Kg'], name='Descarga DBO5 (Kg)', yaxis='y2', opacity=0.3))\n",
        "\n",
        "    fig_cons.update_layout(yaxis=dict(title=\"Consumo (L/kWh/m¬≥)\", side=\"left\"),\n",
        "                           yaxis2=dict(title=\"DBO5 (Kg)\", overlaying=\"y\", side=\"right\"),\n",
        "                           legend=dict(orientation=\"h\", yanchor=\"bottom\", y=1.02, xanchor=\"right\", x=1))\n",
        "    st.plotly_chart(fig_cons, use_container_width=True)\n",
        "\n",
        "    # 4. Impacto Financiero de Incumplimiento\n",
        "    st.subheader(\"Costo de Multas y N√∫mero de Incumplimientos Vencidos\")\n",
        "\n",
        "    fig_multa = px.bar(df, x='FECHA', y='Costo_Multa_Ambiental',\n",
        "                       title='Costo Mensual por Multas Ambientales',\n",
        "                       labels={'Costo_Multa_Ambiental': 'Costo (COP)', 'FECHA': 'Fecha'})\n",
        "    fig_multa.add_trace(go.Scatter(x=df['FECHA'], y=df['Incumplimientos_Vencidos'], mode='lines+markers',\n",
        "                                   name='Incumplimientos Vencidos', yaxis='y2', line=dict(color='red')))\n",
        "\n",
        "    fig_multa.update_layout(yaxis=dict(title=\"Costo Multa (COP)\", side=\"left\"),\n",
        "                           yaxis2=dict(title=\"Incumplimientos Vencidos\", overlaying=\"y\", side=\"right\"),\n",
        "                           hovermode=\"x unified\")\n",
        "    st.plotly_chart(fig_multa, use_container_width=True)\n",
        "\n",
        "\n",
        "# --- M√≥dulo Riesgos HSEQ ---\n",
        "def display_riesgos_hseq_module(df_riesgos: pd.DataFrame):\n",
        "    st.title(\"üö® M√≥dulo Riesgos HSEQ (Salud, Seguridad, Ambiente y Calidad)\")\n",
        "    st.subheader(\"Monitoreo de Incidentes y Cumplimiento Normativo\")\n",
        "\n",
        "    if df_riesgos.empty:\n",
        "        st.warning(\"No se encontraron datos de Riesgos HSEQ. Por favor, cargue el archivo `riesgos_hseq.xlsx`.\")\n",
        "        return\n",
        "\n",
        "    df = df_riesgos.sort_values('FECHA').copy()\n",
        "\n",
        "    # C√°lculos HSEQ Cl√°sicos (Tasa de Frecuencia y Severidad)\n",
        "    total_incidentes = df[df['Tipo_Evento'] == 'Accidente Laboral'].shape[0]\n",
        "    total_horas = df['Horas_Trabajadas_Periodo'].sum()\n",
        "    total_dias_perdidos = df['Dias_Perdidos'].sum()\n",
        "\n",
        "    # Tasa de Frecuencia (IF) = (Total Incidentes / Horas Trabajadas) * 240,000\n",
        "    indice_frecuencia = (total_incidentes / total_horas) * 240000 if total_horas > 0 else 0\n",
        "    # Tasa de Severidad (IS) = (D√≠as Perdidos / Horas Trabajadas) * 240,000\n",
        "    indice_severidad = (total_dias_perdidos / total_horas) * 240000 if total_horas > 0 else 0\n",
        "\n",
        "    # 1. Indicadores Clave de Riesgo\n",
        "    st.subheader(\"√çndices de Seguridad y Salud en el Trabajo\")\n",
        "\n",
        "    col1, col2, col3, col4 = st.columns(4)\n",
        "    col1.metric(\"Total Incidentes (Accidentes)\", f\"{total_incidentes:,}\")\n",
        "    col2.metric(\"√çndice de Frecuencia (IF)\", f\"{indice_frecuencia:.2f}\", help=\"Incidentes por 240,000 horas hombre\")\n",
        "    col3.metric(\"√çndice de Severidad (IS)\", f\"{indice_severidad:.2f}\", delta_color=\"inverse\", help=\"D√≠as perdidos por 240,000 horas hombre\")\n",
        "    col4.metric(\"Costo Total Acumulado Incidentes\", f\"COP {df['Costo_Total_Accidente'].sum():,.0f}\", delta_color=\"inverse\")\n",
        "\n",
        "    # 2. Clasificaci√≥n de Eventos\n",
        "    st.subheader(\"Distribuci√≥n de Eventos de Riesgo\")\n",
        "\n",
        "    event_counts = df['Tipo_Evento'].value_counts().reset_index()\n",
        "    event_counts.columns = ['Tipo_Evento', 'Conteo']\n",
        "\n",
        "    fig_event = px.bar(event_counts, x='Tipo_Evento', y='Conteo',\n",
        "                       title='Conteo por Tipo de Evento (Accidente, Incumplimiento, No Conformidad)',\n",
        "                       labels={'Conteo': 'N√∫mero de Eventos', 'Tipo_Evento': 'Tipo de Evento'},\n",
        "                       color='Tipo_Evento', color_discrete_sequence=px.colors.qualitative.Bold)\n",
        "    st.plotly_chart(fig_event, use_container_width=True)\n",
        "\n",
        "    # 3. Cumplimiento Normativo (Checklist)\n",
        "    st.subheader(\"Estado de Cumplimiento de Checklists Normativos\")\n",
        "\n",
        "    cumplimiento = df['Estado_Checklist'].value_counts().reset_index()\n",
        "    cumplimiento.columns = ['Estado', 'Conteo']\n",
        "\n",
        "    fig_comp = px.pie(cumplimiento, values='Conteo', names='Estado',\n",
        "                      title='Porcentaje de Checklists HSEQ',\n",
        "                      color_discrete_map={'Cumplido': 'green', 'Pendiente': 'yellow', 'Vencido': 'red'})\n",
        "    st.plotly_chart(fig_comp, use_container_width=True)\n",
        "\n",
        "\n",
        "# --- M√≥dulo Comercial ---\n",
        "def display_comercial_module(df_comercial: pd.DataFrame):\n",
        "    st.title(\"üìà M√≥dulo Comercial: Gesti√≥n de Ventas y Margen\")\n",
        "\n",
        "    if df_comercial.empty:\n",
        "        st.warning(\"No se encontraron datos comerciales. Por favor, cargue el archivo `comercial.xlsx`.\")\n",
        "        return\n",
        "\n",
        "    # 1. Indicadores Clave\n",
        "    st.subheader(\"M√©tricas de Venta y Rentabilidad\")\n",
        "\n",
        "    total_ingresos = df_comercial['Ingreso_Total'].sum()\n",
        "    total_margen_bruto = df_comercial['Margen_Bruto'].sum()\n",
        "    margen_bruto_pct = (total_margen_bruto / total_ingresos) * 100 if total_ingresos > 0 else 0\n",
        "\n",
        "    col1, col2, col3, col4 = st.columns(4)\n",
        "    col1.metric(\"Ingreso Total (Acumulado)\", f\"COP {total_ingresos:,.0f}\")\n",
        "    col2.metric(\"Margen Bruto Total\", f\"COP {total_margen_bruto:,.0f}\")\n",
        "    col3.metric(\"Margen Bruto (%)\", f\"{margen_bruto_pct:.2f}%\")\n",
        "    col4.metric(\"Total de Transacciones\", f\"{df_comercial.shape[0]:,}\")\n",
        "\n",
        "    # 2. An√°lisis Temporal de Margen\n",
        "    df_mensual = df_comercial.set_index('FECHA').resample('M').agg({\n",
        "        'Ingreso_Total': 'sum',\n",
        "        'Margen_Bruto': 'sum',\n",
        "        'Volumen_Vendido': 'sum'\n",
        "    }).reset_index()\n",
        "    df_mensual['Margen_Bruto_Pct'] = (df_mensual['Margen_Bruto'] / df_mensual['Ingreso_Total']) * 100\n",
        "\n",
        "    st.subheader(\"Tendencia de Margen Bruto Mensual\")\n",
        "    fig1 = px.area(df_mensual, x='FECHA', y='Margen_Bruto_Pct',\n",
        "                   title='Margen Bruto Porcentual a lo largo del Tiempo',\n",
        "                   labels={'Margen_Bruto_Pct': 'Margen Bruto (%)', 'FECHA': 'Fecha'})\n",
        "    st.plotly_chart(fig1, use_container_width=True)\n",
        "\n",
        "    # 3. Top 10 Productos por Margen\n",
        "    st.subheader(\"Top 10 Productos por Margen Bruto\")\n",
        "    top_productos = df_comercial.groupby('Producto_ID')['Margen_Bruto'].sum().nlargest(10).reset_index()\n",
        "\n",
        "    fig2 = px.bar(top_productos, x='Margen_Bruto', y='Producto_ID', orientation='h',\n",
        "                  title='Top 10 Productos por Margen Bruto Acumulado',\n",
        "                  labels={'Margen_Bruto': 'Margen Bruto (COP)', 'Producto_ID': 'ID Producto'})\n",
        "    fig2.update_yaxes(categoryorder='total ascending')\n",
        "    st.plotly_chart(fig2, use_container_width=True)\n",
        "\n",
        "\n",
        "# --- M√≥dulo Operativo (Productividad/Procesos) ---\n",
        "def display_operativo_module(df_operativo: pd.DataFrame):\n",
        "    st.title(\"üè≠ M√≥dulo Operativo (Productividad y Procesos)\")\n",
        "\n",
        "    if df_operativo.empty:\n",
        "        st.warning(\"No se encontraron datos operativos. Por favor, cargue el archivo `productividad.xlsx`.\")\n",
        "        return\n",
        "\n",
        "    # 1. Indicadores Clave\n",
        "    st.subheader(\"M√©tricas de Eficiencia de Producci√≥n\")\n",
        "\n",
        "    # M√©tricas Operativas\n",
        "    avg_oee = df_operativo['OEE_Teorico'].mean() * 100\n",
        "    avg_tasa_defectos = df_operativo['Tasa_Defectos'].mean() * 100\n",
        "    total_costo_reproceso = df_operativo['Costo_Total_Reproceso'].sum()\n",
        "\n",
        "    col1, col2, col3, col4 = st.columns(4)\n",
        "    col1.metric(\"OEE Promedio (Te√≥rico)\", f\"{avg_oee:.2f}%\", delta_color=\"normal\", help=\"Eficiencia General del Equipo - Simplificado.\")\n",
        "    col2.metric(\"Tasa Promedio de Defectos\", f\"{avg_tasa_defectos:.2f}%\", delta_color=\"inverse\")\n",
        "    col3.metric(\"Costo Acumulado de Reproceso\", f\"COP {total_costo_reproceso:,.0f}\", delta_color=\"inverse\")\n",
        "    col4.metric(\"Horas Operadas Totales\", f\"{df_operativo['Horas_Operadas'].sum():,.0f} h\")\n",
        "\n",
        "    # 2. OEE y Tasa de Defectos\n",
        "    st.subheader(\"Tendencia de Eficiencia y Calidad\")\n",
        "\n",
        "    df_operativo['Mes_A√±o'] = df_operativo['FECHA'].dt.to_period('M').astype(str)\n",
        "\n",
        "    fig1 = go.Figure()\n",
        "    fig1.add_trace(go.Scatter(x=df_operativo['Mes_A√±o'], y=df_operativo['OEE_Teorico'] * 100, mode='lines+markers', name='OEE (%)', yaxis='y1'))\n",
        "    fig1.add_trace(go.Scatter(x=df_operativo['Mes_A√±o'], y=df_operativo['Tasa_Defectos'] * 100, mode='lines+markers', name='Tasa de Defectos (%)', yaxis='y2', line=dict(color='red')))\n",
        "\n",
        "    fig1.update_layout(\n",
        "        title='OEE y Tasa de Defectos a lo Largo del Tiempo',\n",
        "        xaxis_title='Fecha',\n",
        "        yaxis=dict(title=\"OEE (%)\", side=\"left\", range=[0, 100]),\n",
        "        yaxis2=dict(title=\"Tasa de Defectos (%)\", overlaying=\"y\", side=\"right\", range=[0, df_operativo['Tasa_Defectos'].max()*100*1.1])\n",
        "    )\n",
        "    st.plotly_chart(fig1, use_container_width=True)\n",
        "\n",
        "\n",
        "    # 3. Reproceso vs. Costo\n",
        "    st.subheader(\"Costo de Reproceso vs. Unidades Defectuosas\")\n",
        "\n",
        "    fig2 = px.scatter(df_operativo, x='Unidades_Defectuosas', y='Costo_Total_Reproceso',\n",
        "                      size='Costo_Mano_Obra_Hora', color='Planta_ID', hover_name='FECHA',\n",
        "                      title='Relaci√≥n entre Defectos y Costo de Reproceso (Tama√±o: Costo Mano de Obra)')\n",
        "    st.plotly_chart(fig2, use_container_width=True)\n",
        "\n",
        "# --- Dashboard General ---\n",
        "def display_dashboard(all_dfs: Dict[str, pd.DataFrame]):\n",
        "    st.title(\"üåê Dashboard General: Visi√≥n 360\")\n",
        "    st.subheader(\"Resumen de M√©tricas Clave de la Plataforma\")\n",
        "\n",
        "    st.markdown(\"\"\"\n",
        "        Este dashboard ofrece una perspectiva de alto nivel del rendimiento de **Acuamar S.A.**,\n",
        "        consolidando los KPIs m√°s cr√≠ticos de los 7 m√≥dulos.\n",
        "    \"\"\")\n",
        "\n",
        "    # Extraer m√©tricas clave para el Dashboard\n",
        "    metrics = {}\n",
        "\n",
        "    # M√≥dulo Financiero\n",
        "    df_financiero = all_dfs.get('df_financiero')\n",
        "    if not df_financiero.empty:\n",
        "        last_fin = df_financiero.loc[df_financiero['FECHA'].idxmax()]\n",
        "        ingresos = last_fin['Ventas_Gravadas']\n",
        "        egresos_operativos = last_fin['Gastos_Gravados'] + last_fin['Gasto_Nomina']\n",
        "        metrics['Margen_Neto_Op'] = ingresos - egresos_operativos\n",
        "        metrics['Efectivo_Final'] = df_financiero['Efectivo_Inicial'].iloc[-1]\n",
        "\n",
        "    # M√≥dulo Comercial\n",
        "    df_comercial = all_dfs.get('df_comercial')\n",
        "    if not df_comercial.empty:\n",
        "        total_ingresos = df_comercial['Ingreso_Total'].sum()\n",
        "        total_margen_bruto = df_comercial['Margen_Bruto'].sum()\n",
        "        metrics['Margen_Bruto_Pct'] = (total_margen_bruto / total_ingresos) * 100 if total_ingresos > 0 else 0\n",
        "\n",
        "    # M√≥dulo Social (RRHH)\n",
        "    df_rrhh = all_dfs.get('df_rrhh')\n",
        "    if not df_rrhh.empty:\n",
        "        metrics['Rotacion_Anual'] = df_rrhh['Tasa_Rotacion_Anual'].iloc[-1]\n",
        "        metrics['FTEs'] = df_rrhh['FTEs_Promedio'].iloc[-1]\n",
        "\n",
        "    # M√≥dulo Ambiental\n",
        "    df_sostenibilidad = all_dfs.get('df_sostenibilidad')\n",
        "    if not df_sostenibilidad.empty:\n",
        "        metrics['Huella_CO2e_Total'] = df_sostenibilidad['Huella_CO2e_Total'].sum()\n",
        "        metrics['Costo_Multas'] = df_sostenibilidad['Costo_Multa_Ambiental'].sum()\n",
        "\n",
        "    # M√≥dulo Riesgos HSEQ\n",
        "    df_riesgos = all_dfs.get('df_riesgos')\n",
        "    if not df_riesgos.empty:\n",
        "        total_incidentes = df_riesgos[df_riesgos['Tipo_Evento'] == 'Accidente Laboral'].shape[0]\n",
        "        total_horas = df_riesgos['Horas_Trabajadas_Periodo'].sum()\n",
        "        metrics['IF_HSEQ'] = (total_incidentes / total_horas) * 240000 if total_horas > 0 else 0\n",
        "\n",
        "    # M√≥dulo Operativo\n",
        "    df_operativo = all_dfs.get('df_operativo')\n",
        "    if not df_operativo.empty:\n",
        "        metrics['OEE_Promedio'] = df_operativo['OEE_Teorico'].mean() * 100\n",
        "        metrics['Tasa_Defectos'] = df_operativo['Tasa_Defectos'].mean() * 100\n",
        "\n",
        "    # 1. Row de Indicadores de Alto Nivel\n",
        "    st.header(\"1. Rendimiento Global\")\n",
        "    col1, col2, col3, col4 = st.columns(4)\n",
        "    col1.metric(\"üí∞ Margen Neto Operativo\", f\"COP {metrics.get('Margen_Neto_Op', 0):,.0f}\", help=\"Ingresos - Egresos Operativos\")\n",
        "    col2.metric(\"üìà Margen Bruto Comercial (%)\", f\"{metrics.get('Margen_Bruto_Pct', 0):.2f}%\")\n",
        "    col3.metric(\"üè≠ OEE Promedio\", f\"{metrics.get('OEE_Promedio', 0):.2f}%\", delta_color=\"normal\")\n",
        "    col4.metric(\"üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Rotaci√≥n Anual (√ölt. Mes)\", f\"{metrics.get('Rotacion_Anual', 0):.2f}%\", delta_color=\"inverse\")\n",
        "\n",
        "    # 2. Row de Indicadores de Riesgo y Sostenibilidad\n",
        "    st.header(\"2. Riesgos y Sostenibilidad\")\n",
        "    col5, col6, col7, col8 = st.columns(4)\n",
        "    col5.metric(\"üö® √çndice Frecuencia HSEQ (IF)\", f\"{metrics.get('IF_HSEQ', 0):.2f}\", delta_color=\"inverse\")\n",
        "    col6.metric(\"üå≥ Huella CO2e (Acumulada)\", f\"{metrics.get('Huella_CO2e_Total', 0):,.0f} Kg\", delta_color=\"inverse\")\n",
        "    col7.metric(\"üíß Costo Multas Ambientales\", f\"COP {metrics.get('Costo_Multas', 0):,.0f}\", delta_color=\"inverse\")\n",
        "    col8.metric(\"üìâ Tasa Promedio de Defectos\", f\"{metrics.get('Tasa_Defectos', 0):.2f}%\", delta_color=\"inverse\")\n",
        "\n",
        "    # 3. Gr√°fico de Tendencia Integrada\n",
        "    st.header(\"3. Tendencias Financieras y Operativas\")\n",
        "\n",
        "    if not df_financiero.empty and not df_operativo.empty:\n",
        "        # Preparar datos para gr√°fico de l√≠nea dual\n",
        "        df_fin_mensual = df_financiero.set_index('FECHA')['Flujo_Neto'].resample('M').sum().reset_index()\n",
        "        df_op_mensual = df_operativo.set_index('FECHA')['OEE_Teorico'].resample('M').mean().reset_index()\n",
        "\n",
        "        df_merge = pd.merge(df_fin_mensual, df_op_mensual, on='FECHA', how='inner')\n",
        "\n",
        "        if not df_merge.empty:\n",
        "            fig_trend = go.Figure()\n",
        "\n",
        "            # Flujo Neto (Eje Y1)\n",
        "            fig_trend.add_trace(go.Bar(x=df_merge['FECHA'], y=df_merge['Flujo_Neto'], name='Flujo Neto (COP)', yaxis='y1', opacity=0.6))\n",
        "\n",
        "            # OEE (Eje Y2)\n",
        "            fig_trend.add_trace(go.Scatter(x=df_merge['FECHA'], y=df_merge['OEE_Teorico'] * 100, mode='lines+markers', name='OEE (%)', yaxis='y2', line=dict(color='green', width=3)))\n",
        "\n",
        "            fig_trend.update_layout(\n",
        "                title='Relaci√≥n: Flujo Neto (Finanzas) vs. OEE (Operaciones)',\n",
        "                xaxis_title='Fecha',\n",
        "                yaxis=dict(title=\"Flujo Neto (COP)\", side=\"left\"),\n",
        "                yaxis2=dict(title=\"OEE (%)\", overlaying=\"y\", side=\"right\", range=[0, 100]),\n",
        "                legend=dict(orientation=\"h\", yanchor=\"bottom\", y=1.02, xanchor=\"right\", x=1)\n",
        "            )\n",
        "            st.plotly_chart(fig_trend, use_container_width=True)\n",
        "\n",
        "\n",
        "# ==============================================================================\n",
        "# 5. FLUJO PRINCIPAL DE LA APLICACI√ìN\n",
        "# ==============================================================================\n",
        "\n",
        "if check_password():\n",
        "\n",
        "    # Carga de archivos al inicio de la sesi√≥n\n",
        "    if 'data_loaded' not in st.session_state:\n",
        "        st.session_state['data_loaded'] = False\n",
        "        st.session_state['dfs'] = {}\n",
        "        st.session_state['HORIZONTE_PROYECCION'] = HORIZONTE_PROYECCION_DEFAULT\n",
        "        st.session_state['NUM_SIMULACIONES'] = NUM_SIMULACIONES_DEFAULT\n",
        "\n",
        "    st.sidebar.markdown(\"---\")\n",
        "\n",
        "    # Secci√≥n de Carga de Archivos\n",
        "    with st.sidebar.expander(\"üìÇ Cargar Datos\"):\n",
        "        st.caption(\"Cargue todos los archivos .xlsx requeridos. Puede subir varios archivos Excel, y el sistema buscar√° las hojas correspondientes por nombre (financiero, comercial, rrhh_social, sostenibilidad, riesgos_hseq, productividad).\")\n",
        "        uploaded_files = st.file_uploader(\n",
        "            \"Arrastre y suelte los archivos .xlsx aqu√≠\",\n",
        "            type=['xlsx'],\n",
        "            accept_multiple_files=True\n",
        "        )\n",
        "        if uploaded_files:\n",
        "            # Bot√≥n de carga y procesamiento (solo se ejecuta si hay archivos y no se ha cargado)\n",
        "            if st.button(\"Procesar Archivos Cargados\"):\n",
        "                st.session_state['dfs'] = load_data_from_upload(uploaded_files)\n",
        "                st.session_state['data_loaded'] = True\n",
        "                st.success(\"¬°Datos cargados y pre-procesados con √©xito!\")\n",
        "\n",
        "    # Placeholder de Conexi√≥n SQL\n",
        "    st.sidebar.markdown(\"---\")\n",
        "    st.sidebar.subheader(\"Conexi√≥n a Datos Vivos (Simulado)\")\n",
        "    st.sidebar.success(\"Estado: Conectado a SQL DB (Simulaci√≥n)\")\n",
        "\n",
        "    st.sidebar.markdown(\"---\")\n",
        "    st.sidebar.subheader(\"Navegaci√≥n por M√≥dulos\")\n",
        "\n",
        "    # Selector de m√≥dulo en el sidebar\n",
        "    selected_module = st.sidebar.radio(\"Selecciona un M√≥dulo\", MODULOS)\n",
        "\n",
        "    # Slider de Horizonte de Proyecci√≥n para M√≥dulos Predictivos\n",
        "    st.sidebar.markdown(\"---\")\n",
        "    st.session_state['HORIZONTE_PROYECCION'] = st.sidebar.slider(\n",
        "        \"Horizonte de Proyecci√≥n (Meses)\",\n",
        "        min_value=3, max_value=24,\n",
        "        value=st.session_state['HORIZONTE_PROYECCION'],\n",
        "        step=1\n",
        "    )\n",
        "    st.session_state['NUM_SIMULACIONES'] = st.sidebar.slider(\n",
        "        \"N√∫mero de Simulaciones (Monte Carlo)\",\n",
        "        min_value=1000, max_value=10000,\n",
        "        value=st.session_state['NUM_SIMULACIONES'],\n",
        "        step=1000\n",
        "    )\n",
        "\n",
        "\n",
        "    # Contenido central basado en el m√≥dulo seleccionado\n",
        "    if not st.session_state['data_loaded']:\n",
        "        st.title(\"Bienvenido a Horizonte Empresarial 360\")\n",
        "        st.info(\"Por favor, cargue los archivos de datos en la secci√≥n 'Cargar Datos' del men√∫ lateral para comenzar a navegar por los m√≥dulos.\")\n",
        "    else:\n",
        "        dfs = st.session_state['dfs']\n",
        "\n",
        "        if selected_module == \"Dashboard General\":\n",
        "            display_dashboard(dfs)\n",
        "\n",
        "        elif selected_module == \"M√≥dulo Gobernanza y Due√±os\":\n",
        "            display_gobernanza_module(dfs)\n",
        "\n",
        "        elif selected_module == \"M√≥dulo Financiero\":\n",
        "            display_financiero_module(dfs['df_financiero'], st.session_state['HORIZONTE_PROYECCION'], st.session_state['NUM_SIMULACIONES'])\n",
        "\n",
        "        elif selected_module == \"M√≥dulo Sostenibilidad Social RRHH\":\n",
        "            display_rrhh_module(dfs['df_rrhh'])\n",
        "\n",
        "        elif selected_module == \"M√≥dulo Sostenibilidad Ambiental\":\n",
        "            display_sostenibilidad_ambiental_module(dfs['df_sostenibilidad'])\n",
        "\n",
        "        elif selected_module == \"M√≥dulo Riesgos HSEQ\":\n",
        "            display_riesgos_hseq_module(dfs['df_riesgos'])\n",
        "\n",
        "        elif selected_module == \"M√≥dulo Comercial\":\n",
        "            display_comercial_module(dfs['df_comercial'])\n",
        "\n",
        "        elif selected_module == \"M√≥dulo Operativo (Productividad)\":\n",
        "            display_operativo_module(dfs['df_operativo'])"
      ],
      "outputs": [],
      "execution_count": null,
      "metadata": {
        "id": "XbcV3BZ_wKkm"
      }
    }
  ],
  "metadata": {
    "colab": {
      "provenance": [],
      "include_colab_link": true
    },
    "kernelspec": {
      "display_name": "Python 3",
      "name": "python3"
    }
  },
  "nbformat": 4,
  "nbformat_minor": 0
}